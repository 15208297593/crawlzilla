#!/bin/bash

bin=`dirname "$0"`
bin=`cd "$bin"; pwd`
. ../conf/crawlzilla-env.sh

if [ "`id -u`" != "0" ]; then
  echo `whoami` > /tmp/username
fi

# change as root to run install
[ "`id -u`" != "0" ] && exec sudo su -c "$0" "$@"


####### parameter section ###########
# env
CRAWLZILLA_HOME="/opt/crawlzilla"
PACKAGES_HOME="/opt/crawlzilla/packages"
NUTCH_PKG="apache-nutch-1.6-bin.tar.gz"
SOLR_PKG="apache-solr-4.0.0.tgz"
CRAWLDB="/opt/crawlzilla/crawlDB"
NUTCH_HOME="/opt/crawlzilla/nutch"
TOMCAT_HOME="/opt/crawlzilla/tomcat"
SOLR_HOME="/opt/crawlzilla/solr"
URLS="/opt/crawlzilla/nutch/urls"
WORK_PATH=`dirname "$0"`
USERNAME=`cat /tmp/username`
cd $WORK_PATH
### check env

# check package and create folders
function check_package(){
  show_echo "check_package() run.."

  if [ ! -d $CRAWLDB ]; then
    mkdir -p $CRAWLDB
  fi

#  if [ ! -d $URLS ]; then
#    mkdir -p $URLS
#  fi

#  if [ ! -d $NUTCH_HOME ]; then
#    mkdir -p $NUTCH_HOME
#  fi

#  if [ ! -d $SOLR_HOME ]; then
#    mkdir -p $SOLR_HOME
#  fi

  if [ ! -d $PACKAGES_HOME ]; then
    mkdir -p $PACKAGES_HOME
  fi

  if [ ! -f $PACKAGES_HOME/$SOLR_PKG ]; then
    wget $SOLR_PKG_LINK -O $SOLR_PKG
    mv $SOLR_PKG $PACKAGES_HOME
  fi

  if [ ! -f $PACKAGES_HOME/$NUTCH_PKG ]; then
    wget $NUTCH_PKG_LINK -O $NUTCH_PKG
    mv $NUTCH_PKG $PACKAGES_HOME
  fi
}

# check JAVA
# check SSH

### install and setup nutch
function install_nutch(){
  show_echo "install nutch ..."
  # extract tar
  tar zxvf $PACKAGES_HOME/$NUTCH_PKG -C $CRAWLZILLA_HOME 
  # rename folder
  mv $CRAWLZILLA_HOME/apache-nutch-1.6 $NUTCH_HOME
  show_echo "mv $CRAWLZILLA_HOME/apache-nutch-1.6 $NUTCH_HOME"
  # cp conf
  cp ../conf/nutch-site.xml.czl_version  $NUTCH_HOME/conf/nutch-site.xml
  if [ ! -d $URLS ]; then
    mkdir -p $URLS
  fi
  # set JAVA_HOME /etc/profile
}


### install and setup solr
function install_solr(){
  show_echo "install solr.."
  ## extract tar
  tar zxvf $PACKAGES_HOME/$SOLR_PKG -C $CRAWLZILLA_HOME
  # mv folder
  mv $CRAWLZILLA_HOME/apache-solr-4.0.0 $CRAWLZILLA_HOME/solr
  # cp conf
  cp ../conf/schema.xml.czl_version $SOLR_HOME/example/solr/collection1/conf/schema.xml

}

function startup_services(){
  # solr
  java -jar $SOLR_HOME/example/start.jar & 

}


function main(){
  show_echo "main function go.."
  show_echo $USERNAME
  show_echo $WORK_PATH
  check_package
  install_nutch
  install_solr
  chown -R $USERNAME:$USERNAME $CRAWLZILLA_HOME
}

main
